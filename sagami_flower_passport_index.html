<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ã¿ã‚“ãªã§æ¢ãã† ç›¸æ¨¡ã®èŠ±ï½œãƒ‘ã‚¹ãƒãƒ¼ãƒˆ</title>
<style>
  :root{--bg:#0b1020;--card:#10162b;--ink:#e9eefc;--muted:#9fb0da;--accent:#a6e3a1;--brand:#89b4fa}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:radial-gradient(1200px 800px at 80% -20%,#142143 0%,#0b1020 40%,#0b1020 100%);color:var(--ink);font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif}
  .wrap{max-width:1000px;margin:0 auto;padding:24px 16px 64px}
  header{display:flex;align-items:center;gap:16px;flex-wrap:wrap;justify-content:space-between;margin-bottom:16px}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(137,180,250,.15);color:var(--brand);border:1px solid rgba(137,180,250,.35)}
  .title{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .title h1{margin:0;font-size:clamp(20px,4vw,28px)}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.3),inset 0 1px 0 rgba(255,255,255,.05)}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}
  .flower{display:grid;place-items:center;padding:16px;min-height:480px}
  svg{width:100%;max-width:520px;height:auto}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input[type="text"]{background:#0e1430;color:var(--ink);border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px 12px;font-size:14px;outline:none}
  button{background:#17224a;color:var(--ink);border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px 12px;font-size:14px;cursor:pointer;transition:.2s ease transform,.2s ease background}
  button:hover{transform:translateY(-1px);background:#1b2a58}
  .btn-ghost{background:transparent;border-color:rgba(255,255,255,.25)}
  .muted{color:var(--muted);font-size:13px}
  .progressbar{height:10px;background:#0f1531;border:1px solid rgba(255,255,255,.1);border-radius:999px;overflow:hidden}
  .progressbar>div{height:100%;width:0;background:linear-gradient(90deg,#a6e3a1,#89dceb,#cba6f7);transition:width .4s ease}
  details{border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px;background:rgba(255,255,255,.02)}
  details+details{margin-top:12px}
  summary{cursor:pointer;font-weight:600}
  code{background:#0f1636;border:1px solid rgba(255,255,255,.08);padding:2px 6px;border-radius:6px}
  .toast{position:fixed;inset:auto 16px 16px 16px;margin-left:auto;max-width:520px;background:#0f1636;border:1px solid rgba(255,255,255,.12);color:var(--ink);padding:12px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.4);display:none}
  .toast.show{display:block;animation:fadein .2s ease}
  @keyframes fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  .cert{display:none;text-align:center;padding:16px;border-radius:12px;border:1px dashed rgba(255,255,255,.15);background:rgba(166,227,161,.07)}
  .cert.show{display:block} .cert h3{margin:8px 0}
  .modalScrim{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .modal{max-width:900px;width:100%;max-height:90vh;overflow:auto;background:#10162b;border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px;box-shadow:0 20px 50px rgba(0,0,0,.5)}
  .modal h3{margin-top:0}
  .modal .club{font-size:12px;color:var(--muted);margin-bottom:6px}
  .modal .field{display:flex;gap:8px;align-items:center;margin-top:12px}
  .hint{font-size:13px;color:var(--muted);margin-top:8px}
  .prompt{font-size:14px;margin:8px 0;color:#d8e1ff}
  .gallery{display:grid;gap:12px}
  @media(min-width:720px){.gallery{grid-template-columns:1fr 1fr}}
  figure{margin:0}
  figure img{width:100%;height:auto;border:1px solid rgba(255,255,255,.12);border-radius:12px;display:block}
  figure figcaption{font-size:12px;color:var(--muted);margin-top:6px}
  .finalCard{display:none;margin-top:12px}
  .finalCard.show{display:block}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <span class="badge">æ–‡åŒ–ç¥­ å®æ¢ã—</span>
      <h1>ã¿ã‚“ãªã§æ¢ãã† ç›¸æ¨¡ã®èŠ±ï½œãƒ‘ã‚¹ãƒãƒ¼ãƒˆ</h1>
    </div>
    <div class="controls">
      <input id="nickname" type="text" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆä»»æ„ï¼‰" />
      <button id="saveName">ä¿å­˜</button>
      <button id="reset">é€²æ—ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </header>

  <div class="grid">
    <section class="card flower">
      <svg viewBox="-120 -120 240 240" role="img" aria-label="ã€€">
        <g id="petals"></g>
        <circle cx="0" cy="0" r="22" fill="#f5e0dc" stroke="rgba(0,0,0,.25)" stroke-width="1"/>
        <text x="0" y="4" text-anchor="middle" font-size="10" fill="#3b3355"></text>
      </svg>
    </section>

    <section class="card">
      <h2 style="margin-top:4px">é€²æ—</h2>
      <div class="muted" id="progressText">0 / 10 èŠ±ã³ã‚‰</div>
      <div class="progressbar" style="margin:8px 0 14px"><div id="bar"></div></div>

      <!-- Final puzzle card (unlocked at 10/10) -->
      <div id="finalSection" class="finalCard card">
        <h3>ğŸŒ¸ ãƒ©ã‚¹è¬ï¼ˆWebè¡¨ç¤ºã®ã¿ï¼‰</h3>
        <img id="finalImage" src="" alt="ãƒ©ã‚¹è¬ã®ç”»åƒ" style="max-width:100%;border:1px solid rgba(255,255,255,.12);border-radius:12px">
        <div class="field" style="margin-top:12px">
          <button id="toggleFinalHint" class="btn-ghost">ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹</button>
          <button id="openReview" class="btn-ghost">ã“ã‚Œã¾ã§ã®è¬ã‚’è¦‹ã‚‹</button>
        </div>
        <div id="finalHint" class="hint" style="display:none"></div>
        <p class="muted" style="margin-top:8px">â€» ãƒ©ã‚¹è¬ã®è§£ç­”ã¯ã€Œãƒ©ã‚¹è¬ã®ç­”ãˆã€ã§ã€‚Webã§ã¯åˆ¤å®šã—ã¾ã›ã‚“ã€‚</p>
      </div>
      
    </section>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- Past puzzles (review) modal -->
<div id="reviewScrim" class="modalScrim" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <h3>ã“ã‚Œã¾ã§ã®è¬</h3>
    <p class="muted">å„å›£ä½“ã§æ²ç¤ºã•ã‚ŒãŸè¬ã®ç”»åƒï¼ˆå¾©ç¿’ç”¨ï¼‰ã€‚</p>
    <div id="reviewGallery" class="gallery"></div>
    <div class="field"><button id="closeReview">é–‰ã˜ã‚‹</button></div>
  </div>
</div>

<!-- Answer modal for normal points -->
<div id="scrim" class="modalScrim" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <div class="club" id="modalClub"></div>
    <h3 id="modalTitle"></h3>
    <div id="modalPrompt" class="prompt" style="display:none"></div>
    <div class="field" style="margin-top:0">
      <button id="toggleHint" class="btn-ghost">ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹</button>
    </div>
    <div class="hint" id="modalHint" style="display:none"></div>
    <div class="field">
      <input id="answer" type="text" placeholder="ã“ã“ã«ç­”ãˆã‚’å…¥åŠ›" />
      <button id="submitAnswer">ç­”ãˆã‚‹</button>
      <button id="closeModal">é–‰ã˜ã‚‹</button>
    </div>
    <div class="hint" id="feedback" style="display:none"></div>
  </div>
</div>

<script>
(function(){
  const PETAL_COUNT = 10;
  const PALETTE = ["#f38ba8","#fab387","#f9e2af","#a6e3a1","#94e2d5","#89dceb","#b4befe","#cba6f7","#f5c2e7","#f2cdcd"];
  const STORAGE_KEY = "sagamiFlower.final.display.inline";
  const CLEAR_SALT = "SAGAMI25DISPLAYINLINE";
  const SHOW_PROMPT = false; // æ™®é€šè¬ã®æœ¬æ–‡ã‚’ã‚µã‚¤ãƒˆã«å‡ºã™å ´åˆ true

  // â˜… ãƒ©ã‚¹è¬ï¼ˆWebè¡¨ç¤ºã®ã¿ï¼‰
  const FINAL_IMAGE = "final_puzzle.png"; // åŒãƒ•ã‚©ãƒ«ãƒ€ or å¤–éƒ¨URL
  const FINAL_HINT  = "ãƒ’ãƒ³ãƒˆä¾‹ï¼šã“ã‚Œã¾ã§ã®â€œèŠ±ã³ã‚‰â€ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹å…±é€šç‚¹ã«æ³¨ç›®ã€‚";

  // â˜… æ™®é€šã®è¬ï¼ˆç´™æ²ç¤ºï¼‰â€” Webå´ã¯ç­”ãˆåˆ¤å®šã®ã¿ã€‚hint ã¯ä»»æ„ã€‚
  const PUZZLES = [{"id": 1, "club": "æ›¸é“éƒ¨", "title": "ã²ã‚‰ãŒãª8æ–‡å­—ã§å›ç­”", "prompt": "", "hint": "ã€Œç”Ÿã€ã£ã¦å­—ã«ã¯ã„ã‚ã‚“ãªèª­ã¿æ–¹ã‚ã‚‹ã‚ˆã­", "answer_hashes": [2727450628]}, {"id": 2, "club": "é‰„é“ç ”ç©¶åŒå¥½ä¼š", "title": "ã²ã‚‰ãŒãª5æ–‡å­—ã§å›ç­”", "prompt": "", "hint": "ä¸Šã¨ä¸‹ã§è‰²ã‚’å¯¾å¿œã•ã›ã‚ˆã†", "answer_hashes": [602862285]}, {"id": 3, "club": "åŒ–å­¦éƒ¨", "title": "ã‚«ã‚¿ã‚«ãƒŠ3æ–‡å­—ã§å›ç­”", "prompt": "", "hint": "åŒ–å­¦ã§ä½¿ã†ã‚ã®è¨˜å·", "answer_hashes": [213775345]}, {"id": 4, "club": "æ–‡èŠ¸éƒ¨", "title": "ã²ã‚‰ãŒãª3æ–‡å­—ã§å›ç­”", "prompt": "", "hint": "ã€Œã‚ã€ã€ŒãŸã€ã€Œã—ã€ã®å‰ã«ã‚ã‚‹ã®ã¯ï¼Ÿ", "answer_hashes": [213781051, 214943021]}, {"id": 5, "club": "ç¾è¡“éƒ¨", "title": "ã‚«ã‚¿ã‚«ãƒŠ3æ–‡å­—ã§å›ç­”", "prompt": "", "hint": "RGBã¨ã‹CMYã¨ã‹ã®ã‚ã‚Œ", "answer_hashes": [213682668]}, {"id": 6, "club": "å›²ç¢å°†æ£‹éƒ¨", "title": "ã²ã‚‰ãŒãª3æ–‡å­—ã§å›ç­”", "prompt": "", "hint": "ã“ã‚Œã¯å°†æ£‹ç›¤ã˜ã‚ƒãªãã¦ï¼Ÿ", "answer_hashes": [214466852]}, {"id": 7, "club": "è¯é“åŒå¥½ä¼š", "title": "ã‚«ã‚¿ã‚«ãƒŠ3æ–‡å­—ã§å›ç­”", "prompt": "", "hint": "èŠ±ã®è‰²ã‚’è‹±èªã«ã—ã¦ã¿ã‚ˆã†", "answer_hashes": [213801658]}, {"id": 8, "club": "ç”Ÿç‰©éƒ¨", "title": "ã‚«ã‚¿ã‚«ãƒŠ6æ–‡å­—ã§å›ç­”", "prompt": "", "hint": "ä¸€ç•ªä¸‹ã¯é­šã˜ã‚ƒãªãã¦é“å…·ï¼ï¼Ÿ", "answer_hashes": [2939599442]}, {"id": 9, "club": "å†™çœŸéƒ¨", "title": "ã²ã‚‰ãŒãª3æ–‡å­—ã§å›ç­”", "prompt": "", "hint": "ãã‚Œãã‚Œã®å››è§’ã”ã¨ã«æ³•å‰‡æ€§ãŒã‚ã‚Šãã†", "answer_hashes": [214617677]}, {"id": 10, "club": "ç‰©ç†éƒ¨", "title": "ã²ã‚‰ãŒãª4æ–‡å­—ã§å›ç­”", "prompt": "", "hint": "ãƒ—ãƒ­ã‚°ãƒ©ãƒ é€šã‚Šã«é§’ã‚’å‹•ã‹ã—ã¦ã¿ã‚ˆã†", "answer_hashes": [2325878309]}];

  // â˜… å¾©ç¿’ç”»åƒï¼ˆ10æšï¼‰ã€‚åŒãƒ•ã‚©ãƒ«ãƒ€ã« p1.png...p10.png ã‚’ç½®ãæƒ³å®šï¼ˆå¤–éƒ¨URLã§ã‚‚OKï¼‰
  const REVIEW_IMAGES = [{"src": "p1.png", "caption": "ç¬¬1ã®è¬ï¼ˆæ›¸é“éƒ¨ï¼‰"}, {"src": "p2.png", "caption": "ç¬¬2ã®è¬ï¼ˆé‰„é“ç ”ç©¶åŒå¥½ä¼šï¼‰"}, {"src": "p3.png", "caption": "ç¬¬3ã®è¬ï¼ˆåŒ–å­¦éƒ¨ï¼‰"}, {"src": "p4.png", "caption": "ç¬¬4ã®è¬ï¼ˆæ–‡èŠ¸éƒ¨ï¼‰"}, {"src": "p5.png", "caption": "ç¬¬5ã®è¬ï¼ˆç¾è¡“éƒ¨ï¼‰"}, {"src": "p6.png", "caption": "ç¬¬6ã®è¬ï¼ˆå›²ç¢å°†æ£‹éƒ¨ï¼‰"}, {"src": "p7.png", "caption": "ç¬¬7ã®è¬ï¼ˆè¯é“åŒå¥½ä¼šï¼‰"}, {"src": "p8.png", "caption": "ç¬¬8ã®è¬ï¼ˆç”Ÿç‰©éƒ¨ï¼‰"}, {"src": "p9.png", "caption": "ç¬¬9ã®è¬ï¼ˆå†™çœŸéƒ¨ï¼‰"}, {"src": "p10.png", "caption": "ç¬¬10ã®è¬ï¼ˆç‰©ç†éƒ¨ï¼‰"}];

  // Build petals
  const g = document.getElementById('petals');
  for(let i=0;i<PETAL_COUNT;i++){
    const petal = document.createElementNS("http://www.w3.org/2000/svg","ellipse");
    petal.setAttribute("cx", 0);
    petal.setAttribute("cy", -35);
    petal.setAttribute("rx", 18);
    petal.setAttribute("ry", 36);
    petal.setAttribute("transform", `rotate(${(i*360/PETAL_COUNT)})`);
    petal.setAttribute("id", `petal-${i+1}`);
    petal.setAttribute("fill", "#1a2042");
    petal.setAttribute("stroke", "rgba(255,255,255,.15)");
    petal.setAttribute("stroke-width", "1");
    g.appendChild(petal);
  }

  // State
  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : { name:"", collected:Array(PETAL_COUNT).fill(false) };
    }catch(e){ return { name:"", collected:Array(PETAL_COUNT).fill(false) }; }
  }
  function save(st){ localStorage.setItem(STORAGE_KEY, JSON.stringify(st)); }
  function setName(n){ const st = load(); st.name = (n||"").trim(); save(st); render(); }
  function collect(idx){
    const st = load();
    if(!st.collected[idx]){
      st.collected[idx] = true; save(st); showToast(`ğŸŒ¸ èŠ±ã³ã‚‰ ${idx+1} ã‚’ç²å¾—ï¼`);
    }else{ showToast(`ï¼ˆèŠ±ã³ã‚‰ ${idx+1} ã¯ã‚‚ã†é›†ã‚ã¦ã„ã¾ã™ï¼‰`); }
    render();
  }
  function reset(){
    if(confirm("é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")){
      save({ name:"", collected:Array(PETAL_COUNT).fill(false) });
      render();
      showToast("é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
    }
  }
  function hiraKanaNormalize(s){
    if(!s) return "";
    s = s.toString().trim().normalize("NFKC");
    s = Array.from(s).map(ch => {
      const code = ch.charCodeAt(0);
      if(code>=0x30A1 && code<=0x30F6){ return String.fromCharCode(code - 0x60); }
      return ch;
    }).join("");
    return s.toLowerCase();
  }
  function hash131(s){
    let x = 0>>>0; for(let i=0;i<s.length;i++){ x = (x*131 + s.charCodeAt(i))>>>0; } return x>>>0;
  }
  function clearCode(st){
    const s = st.collected.map(b=>b?1:0).join("") + "|" + (st.name||"") + "|" + CLEAR_SALT;
    let h = 0; for(let i=0;i<s.length;i++){ h = (h*131 + s.charCodeAt(i))>>>0; }
    const code = "SGM-" + (st.name||"GUEST").toUpperCase().slice(0,4).padEnd(4,"X") + "-" + (""+h).slice(-6).padStart(6,"0");
    return code;
  }

  // Render
  const finalSection = document.getElementById("finalSection");
  const finalImage = document.getElementById("finalImage");
  const finalHint = document.getElementById("finalHint");
  const cert = document.getElementById("cert");

  function render(){
    const st = load();
    const total = st.collected.filter(Boolean).length;
    for(let i=0;i<PETAL_COUNT;i++){
      const el = document.getElementById(`petal-${i+1}`);
      el.setAttribute("fill", st.collected[i] ? PALETTE[i%PALETTE.length] : "#1a2042");
    }
    document.getElementById("progressText").textContent = `${total} / ${PETAL_COUNT} èŠ±ã³ã‚‰`;
    document.getElementById("bar").style.width = `${Math.round(100*total/PETAL_COUNT)}%`;

    cert.classList.remove("show");
    finalSection.classList.remove("show");

    if(total === PETAL_COUNT){
      // ãƒ©ã‚¹è¬ï¼ˆç”»åƒï¼‰ã‚’è§£æ”¾ï¼ˆè¡¨ç¤ºã®ã¿ï¼‰
      finalImage.src = FINAL_IMAGE;
      finalHint.textContent = FINAL_HINT || "";
      finalHint.style.display = "none";
      finalSection.classList.add("show");

      // åŒæ™‚ã«ã‚¯ãƒªã‚¢ã‚³ãƒ¼ãƒ‰ã‚‚è¡¨ç¤ºï¼ˆåˆ¤å®šã¯ä¸è¦ï¼‰
      document.getElementById("certName").textContent = st.name ? `é”æˆè€…ï¼š${st.name}` : "é”æˆè€…ï¼šGUEST";
      document.getElementById("clearCode").textContent = clearCode(st);
      cert.classList.add("show");
    }

    document.getElementById("nickname").value = st.name || "";
  }

  // Toast
  let hideTimer=null;
  function showToast(msg){ const t = document.getElementById("toast"); t.textContent = msg; t.classList.add("show"); clearTimeout(hideTimer); hideTimer = setTimeout(()=> t.classList.remove("show"), 2500); }

  // Organizer links
  function buildLinks(){
    const base = location.origin + location.pathname;
    const list = []; for(let i=1;i<=PETAL_COUNT;i++){ list.push({i, urlPuzzle: `${base}?p=${i}`, urlClaim: `${base}?claim=p${i}`}); }
    const box = document.getElementById("links");
    box.innerHTML = list.map(o=>`<div>ç¬¬${o.i}ã®èŠ±ã³ã‚‰ï¼š <code>${o.urlPuzzle}</code>ï¼ˆãƒ‘ã‚ºãƒ«ï¼‰ / <code>${o.urlClaim}</code>ï¼ˆç›´ç²å¾—ï¼‰</div>`).join("");
  }

  // Build review gallery
  const reviewGallery = document.getElementById("reviewGallery");
  function buildReview(){
    reviewGallery.innerHTML = REVIEW_IMAGES.map((it,idx)=>`<figure><img loading="lazy" src="${it.src}" alt="${it.caption}"><figcaption>ç¬¬${idx+1}ã®è¬ â€” ${it.caption}</figcaption></figure>`).join("");
  }

  // Normal puzzle modal
  const scrim = document.getElementById('scrim');
  const modalClub = document.getElementById('modalClub');
  const modalTitle = document.getElementById('modalTitle');
  const modalPrompt = document.getElementById('modalPrompt');
  const modalHint = document.getElementById('modalHint');
  const toggleHintBtn = document.getElementById('toggleHint');
  const answerInput = document.getElementById('answer');
  const feedback = document.getElementById('feedback');
  let currentPuzzleIndex = -1;

  function openPuzzle(idx){
    const p = PUZZLES[idx];
    if(!p){ showToast("ã“ã®èŠ±ã³ã‚‰ã¯å­˜åœ¨ã—ã¾ã›ã‚“"); return; }
    currentPuzzleIndex = idx;
    modalClub.textContent = p.club;
    modalTitle.textContent = p.title;

    if(SHOW_PROMPT && p.prompt){
      modalPrompt.style.display = "block";
      modalPrompt.textContent = p.prompt;
    }else{
      modalPrompt.style.display = "none";
      modalPrompt.textContent = "";
    }

    if(p.hint && p.hint.trim()!==""){
      toggleHintBtn.style.display = "inline-block";
      toggleHintBtn.textContent = "ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹";
      modalHint.textContent = p.hint;
      modalHint.style.display = "none";
    }else{
      toggleHintBtn.style.display = "none";
      modalHint.textContent = "";
      modalHint.style.display = "none";
    }

    feedback.style.display = "none";
    answerInput.value = "";
    scrim.style.display = "flex";
    answerInput.focus();
  }
  function closePuzzle(){ scrim.style.display = "none"; currentPuzzleIndex = -1; }
  function submitAnswer(){
    if(currentPuzzleIndex<0) return;
    const p = PUZZLES[currentPuzzleIndex];
    const val = hiraKanaNormalize(answerInput.value);
    const ok = p.answer_hashes.includes(hash131(val));
    if(ok){
      feedback.style.display = "block"; feedback.textContent = "æ­£è§£ï¼èŠ±ã³ã‚‰ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚";
      collect(currentPuzzleIndex);
      setTimeout(closePuzzle, 600);
    }else{
      feedback.style.display = "block"; feedback.textContent = "ã¡ãŒã†ã¿ãŸã„â€¦ ãƒ’ãƒ³ãƒˆã‚’è¦‹ã¦ã‚‚ã†ä¸€åº¦ï¼";
    }
  }

  document.getElementById("submitAnswer").addEventListener("click", submitAnswer);
  document.getElementById("closeModal").addEventListener("click", closePuzzle);
  document.getElementById("toggleHint").addEventListener("click", ()=>{
    if(modalHint.style.display==="none"){
      modalHint.style.display="block"; toggleHintBtn.textContent = "ãƒ’ãƒ³ãƒˆã‚’éš ã™";
    }else{
      modalHint.style.display="none"; toggleHintBtn.textContent = "ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹";
    }
  });

  // Final (display only): hint toggle & review open
  document.getElementById("toggleFinalHint").addEventListener("click", ()=>{
    if(finalHint.style.display==="none"){
      finalHint.style.display="block";
      document.getElementById("toggleFinalHint").textContent = "ãƒ’ãƒ³ãƒˆã‚’éš ã™";
    }else{
      finalHint.style.display="none";
      document.getElementById("toggleFinalHint").textContent = "ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹";
    }
  });
  const reviewScrim = document.getElementById("reviewScrim");
  document.getElementById("openReview").addEventListener("click", ()=>{ reviewScrim.style.display = "flex"; });
  document.getElementById("closeReview").addEventListener("click", ()=>{ reviewScrim.style.display = "none"; });

  // Query handling
  function handleParams(){
    const q = new URLSearchParams(location.search);
    const p = q.get("p");
    const claim = q.get("claim");
    if(p){
      const idx = parseInt(p,10)-1; openPuzzle(idx); history.replaceState({}, "", location.origin + location.pathname);
    }else if(claim){
      const m = /^p([1-9]|10)$/.exec(claim||"");
      if(m){ const idx = parseInt(m[1],10)-1; collect(idx); history.replaceState({}, "", location.origin + location.pathname); }
    }
  }

  // Name & Reset
  document.getElementById("reset").addEventListener("click", reset);
  document.getElementById("saveName").addEventListener("click", ()=> setName(document.getElementById("nickname").value));

  // Keyboard
  window.addEventListener("keydown", (e)=>{
    const scrimVisible = document.getElementById("scrim").style.display==="flex";
    const reviewVisible = document.getElementById("reviewScrim").style.display==="flex";
    if(e.key==="Enter" && scrimVisible){ submitAnswer(); }
    if(e.key==="Escape" && scrimVisible){ closePuzzle(); }
    if(e.key==="Escape" && reviewVisible){ reviewScrim.style.display="none"; }
  });

  // Init
 buildReview(); render(); handleParams();
})();
</script>
</body>
</html>
